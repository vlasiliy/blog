<?php

/**
 * Post
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    blog
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Post extends BasePost
{
    public $tags_id = array();
    
    public function getTagsPost($id_post)
    {
        $q = Doctrine_Query::create()
                ->select('t.*')
                ->from('Tag t')
                ->leftJoin('t.TagPost tp')
                ->andWhere('tp.post_id = ?', $id_post);
 
        return $q->execute();
    }
    
    public function getCountComment($id_post)
    {
        $q = Doctrine_Query::create()
                ->select('count(c.id) as countcomments')
                ->from('Comment c')
                ->where('c.post_id = ?', $id_post);
 
        return $q->execute(array(), Doctrine_Core::HYDRATE_SINGLE_SCALAR);
    }
    
    public static function getPopularPosts()
    {
        $q = Doctrine_Query::create()
                ->select('title')
                ->from('Post p')
                ->limit(sfConfig::get('app_max_post_on_popular'))
                ->orderBy('rating DESC');
 
        return $q->execute();
    }
    
    public function updateRating($post_id)
    {
        $q = Doctrine_Query::create()
                ->update('Post p')
                ->set('p.rating', 'p.rating + 1')
                ->where('p.id = ?', $post_id);
 
        return $q->execute();
    }


    public function getTags()
    {
        $tags = "";
        foreach($this->getTagsPost($this->getId()) as $tag)
        {
            $tags .= $tag->getWord().",";
        }
        return substr($tags, 0, -1);
    }
    
    
    public function setTags($strTags)
    {
        //echo '|'.$post_id.'|';die;
        if(!$this->isNew())
        {
            $post_id = $this->getId();
            $del = Doctrine_Query::create()
                    ->delete()
                    ->from('TagPost')
                    ->andWhere('post_id = '.$post_id)
                    ->execute();
        }
        
        $tags = explode(",", $strTags);
        if($tags[0] != '')
        {
            foreach($tags as $word)
            {
                $word = trim($word);
                $result = Doctrine_Core::getTable('Tag')->findBy('word', $word);
                if($result->count() == 0)
                {
                    $tag = new Tag();
                    $tag->word = $word;
                    $tag->save();
                    $tag_id = $tag->getId();
                }
                else
                {
                    $tag_id = $result->getFirst()->getId();
                }
                $this->tags_id[] = $tag_id;
            }
        }
    }
   
    public function setPostTags($arrTagsId)
    {
        $post_id = $this->getId();
        foreach($arrTagsId as $tag_id)
        {
            $tagpost = new TagPost();
            $tagpost->post_id = $post_id;
            $tagpost->tag_id = $tag_id;
            $tagpost->save();
        }
    }
    
}
